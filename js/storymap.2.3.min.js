(function(a){a.fn.storymap=function(c){var g={selector:"[data-scene]",triggerpos:"30%",navbar:false,navwidget:false,legend:true,loader:true,flyto:false,scalebar:false,scrolldown:true,progressline:true,createMap:function(){var i=L.map(a(".storymap-map")[0],{zoomControl:false}).setView([44,-120],7);L.tileLayer("http://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}@2x.png").addTo(i);return i}};var f=a.extend(g,c);if(typeof(L)==="undefined"){throw new Error("Storymap requires Leaflet.")}function b(j,k){var n=a(window).scrollTop();var i=a(j).offset().top;var m=i-n;var l=k-m;if(l<0){return a(document).height()}return l}function h(m,l){var i=a.map(m,function(n){var o=b(n,l);return{el:a(n),distance:o}});function k(n,o){if(n.distance>o.distance){return o}else{return n}}var j=i.reduce(k);a.each(m,function(o,n){var p=a(n);if(p[0]!==j.el[0]){p.trigger("notviewing")}if(p.height()<=a(window).height()*0.33&&p.has("img").length===0){p.height(a(window).height()*0.33)}});if(!j.el.hasClass("viewing")){j.el.trigger("viewing")}}function e(j,i,k){var l=j.find(i);h(l,k);a(window).scroll(function(){h(l,k)})}document.createElement("video");var d=function(o,l,n){a(o).addClass("storymap");var s=a('<div class="storymap-trigger"></div>').css("top",f.triggerpos);a("body").append(s);var q=s.offset().top-a(window).scrollTop();var u=f.selector;var t=a(o).find(u);var k=f.createMap();var p=L.layerGroup().addTo(k);var i=a("nav");if(f.baselayer){f.baselayer.layer.addTo(k)}if(f.legend){a(".storymap").append("<div class='storymap-legend' />")}if(f.scrolldown){a(".storymap").append("<div class='zoomIn infinite glyphicon glyphicon-menu-down storymap-scroll-down' />")}if(f.scalebar){L.control.scale({position:"bottomright",metric:false}).addTo(k)}if(f.progressline){a(".storymap").append("<div class='storymap-progressline' />")}if(f.navwidget){a(".storymap").append("<div class='storymap-navwidget text-center' />")}if(f.loader){a(".storymap").append("<div class='glyphicon glyphicon-refresh storymap-loader' />")}a(".storymap-map .leaflet-control-attribution").addClass("storymap-attribution").html("<a href='https://github.com/jakobzhao/storymap'><img src='http://jakobzhao.github.io/storymap/img/logo.png' width='18px' target='_blank' > storymap.js </a>");if(f.credits){a(".storymap-attribution").find("a").prepend(f.credits+" | ")}if(f.navbar&&i.length>0){a(".navbar-header").after("<div class='collapse navbar-collapse nav navbar-nav navbar-right storymap-navbar'>");a.each(t,function(w,v){var x=a(v);if(typeof(l[x.data("scene")].name)==="undefined"){sceneName=x.data("scene")}else{sceneName=l[x.data("scene")].name.replace(" ","&nbsp;")}scrollScript="javascript:window.scrollBy(0, $('section[data-scene=\\'"+x.data("scene")+"\\']').offset().top - $(window).scrollTop() - $('.storymap-navbar').height() - 10);";a(".storymap-navbar").append('<li><a title="'+sceneName+'" href="'+scrollScript+'" >'+sceneName+"</a></li>")})}a.each(t,function(w,v){var y=a(v);var x=y.data("background");if(typeof x!=="undefined"){if(x.indexOf("jpg")>=0||x.indexOf("jpeg")>=0||x.indexOf("png")>=0||x.indexOf("bmp")>=0||x.indexOf("gif")>=0){a("head").append("<style> ."+y.data("scene")+"-bg-img { background: url("+x+") no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover;  -o-background-size: cover; background-size: cover; }</style>");a(y).find(".fullscreen").addClass(y.data("scene")+"-bg-img")}else{if(x.indexOf("mp4")>=0){a(y).find(".fullscreen").before('<video class="fullscreen" playsinline autoplay muted loop><source src='+x+'  type="video/mp4"></video>')}else{console.log(x)}}}});if(!String.prototype.includes){String.prototype.includes=function(){return String.prototype.indexOf.apply(this,arguments)!==-1}}if(i.length!==0){var r=i.height();var j=i.position().top;a(".storymap-story").css({top:(r+j).toString()+"px"})}a.each(n,function(w,v){v.layer.on("s");v.layer.on("load",function(){a(".storymap-loader").fadeTo(1000,0)})});function m(x){p.clearLayers();var z=l[x];var v=z.layers;var y="";if(typeof a("section[data-scene='"+x+"']").data("background")!=="undefined"){a(".storymap-loader").fadeTo(0,0)}else{if(typeof v!=="undefined"&&typeof a("section[data-scene='"+x+"']").data("background")==="undefined"){for(var w=0;w<v.length;w++){a(".storymap-loader").fadeTo(0,1);p.addLayer(n[v[w]].layer);if(typeof n[v[w]].legend!=="undefined"){y+=n[v[w]].legend}}}}if(f.legend&&y!==""){a(".storymap-legend").html(y).show()}else{a(".storymap-legend").hide()}if(f.flyto){k.flyTo([z.lat,z.lng],z.zoom,1)}else{k.setView([z.lat,z.lng],z.zoom,1)}k.invalidateSize()}t.on("viewing",function(){a(this).addClass("viewing");var v=a(".storymap-scroll-down");v.css("left","2%");if(typeof a(this).data("background")!=="undefined"){a(this).addClass("section-opacity").css("width","0px").css("padding","0 0 0 0");v.css("left","50%")}if(a(this).data("scene")===t.last().data("scene")){v.removeClass("glyphicon-menu-down").addClass("glyphicon-home")}else{v.removeClass("glyphicon-home").addClass("glyphicon-menu-down")}if(a(this).data("scene")===t.first().data("scene")||a(this).data("scene")===t.last().data("scene")){v.addClass("animated")}else{v.removeClass("animated")}m(a(this).data("scene"))});t.on("notviewing",function(){a(this).removeClass("viewing");if(typeof a(this).data("background")!=="undefined"){a(this).removeClass("section-opacity")}});e(o,u,q);window.scrollTo(0,1);a(".storymap-scroll-down").click(function(){var v=a(".viewing");if(v.data("scene")!==a("section:last").data("scene")){if(i.length!==0){window.scrollBy(0,v.offset().top+v.height()-a(window).scrollTop()-a(".storymap-navbar").height()-10)}else{window.scrollBy(0,v.offset().top+v.height()-a(window).scrollTop()-10)}}else{window.scrollTo(0,0)}});a(window).scroll(function(){var x=a(window).scrollTop(),y=a(document).height(),v=a(window).height();var w=(x/(y-v))*100;a(".storymap-progressline").css("width",(w+"%"))});if(f.navwidget){a.each(t,function(w,v){var x=a(v);if(typeof(l[x.data("scene")].name)==="undefined"){sceneName=x.data("scene")}else{sceneName=l[x.data("scene")].name.replace(" ","&nbsp;")}if(i.length!==0){scrollScript="javascript:window.scrollBy(0, $('section[data-scene=\\'"+x.data("scene")+"\\']').offset().top - $(window).scrollTop() - $('.storymap-navbar').height() - 10);"}else{scrollScript="javascript:window.scrollBy(0, $('section[data-scene=\\'"+x.data("scene")+"\\']').offset().top  - $(window).scrollTop() - 10);"}if(w===0){a(".storymap-navwidget").append('<li><a class="glyphicon glyphicon-home" data-toggle="tooltip" title="'+sceneName+'" href="'+scrollScript+'" ></a></li>')}else{a(".storymap-navwidget").append('<li><a class="glyphicon glyphicon-one-fine-full-dot" data-toggle="tooltip" title="'+sceneName+'" href="'+scrollScript+'" ></a></li>')}});a('[data-toggle="tooltip"]').tooltip({placement:"right",html:true});a(".storymap-navwidget").hover(function(){a(this).fadeTo(100,0.8)},function(){a(this).fadeTo(300,0)})}};d(this,f.scenes,f.layers);window.scrollTo(0,0);return this}}(jQuery));